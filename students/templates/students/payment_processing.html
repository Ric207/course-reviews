{% extends 'base.html' %}

{% block title %}Processing Payment...{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 text-center">
            
            <div class="card shadow border-0 p-5">
                <!-- Spinner -->
                <div class="mb-4">
                    <div class="spinner-border text-success" style="width: 4rem; height: 4rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <h3 class="fw-bold mb-2">Check your phone!</h3>
                <p class="text-muted lead">
                    We've sent an M-Pesa prompt. <br>
                    Please enter your PIN.
                </p>
                
                <!-- Status Message -->
                <div class="alert alert-light border mt-4 mb-4">
                    <small class="text-muted"><i class="bi bi-info-circle"></i> Waiting for network confirmation...</small>
                </div>

                <!-- MANUAL BUTTON (Always Visible) -->
                <!-- This allows you to proceed immediately if the STK push is delayed -->
                <div class="mt-2">
                    <p class="small text-muted mb-2">Did you complete the transaction?</p>
                    <a href="{% url 'students:confirm_payment_manual' %}" class="btn btn-success fw-bold w-100 shadow-sm">
                        I have entered my PIN <i class="bi bi-check-circle-fill ms-2"></i>
                    </a>
                </div>
                
                <p class="small text-muted mt-3">
                    If you didn't receive a prompt, <a href="{% url 'students:payment' %}">try again</a>.
                </p>
            </div>

        </div>
    </div>
</div>

<script>
    // Poll the server every 3 seconds to see if the payment verified automatically
    const checkPayment = setInterval(function() {
        fetch("{% url 'students:check_payment_status' %}")
        .then(response => response.json())
        .then(data => {
            if (data.status === 'completed') {
                clearInterval(checkPayment);
                window.location.href = "{% url 'students:results' %}";
            }
        })
        .catch(error => console.error('Error checking status:', error));
    }, 3000);
</script>
{% endblock %}